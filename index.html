<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot AI - Seu Tutor de Idiomas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem do chat */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-700 */
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-600 */
        }
        /* Anima√ß√£o do microfone */
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(29, 78, 216, 0); }
            100% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0); }
        }
        /* Anima√ß√£o dos pontos de "pensando" */
        .thinking-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Esconde a tela de chat por padr√£o */
        #chat-view {
            display: none;
        }
        #text-input:focus {
            box-shadow: none;
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
 <div class="fixed top-0 left-0 right-0 z-50 w-full text-center py-2 bg-gray-800 shadow-lg"> 
       <p class="text-sm flex justify-center items-center gap-4"> 
         Desenvolvido por Giovanni Fuentes Giannetti:  
         <!-- Instagram --> 
         <a href="https://instagram.com/giovanni.fg" target="_blank" class="text-pink-400 hover:text-pink-300 flex items-center gap-1"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5"> <path d="M12 2.2c3.2 0 3.6 0 4.9.1 1.2.1 1.9.3 2.3.5.6.2 1 .6 1.4 1.1.4.4.9 1 1.1 1.6.2.4.4 1.1.5 2.3.1 1.3.1 1.7.1 4.9s0 3.6-.1 4.9c-.1 1.2-.3 1.9-.5 2.3-.2.6-.6 1-1.1 1.4-.4.4-1 .9-1.6 1.1-.4.2-1.1.4-2.3.5-1.3.1-1.7.1-4.9.1s-3.6 0-4.9-.1c-1.2-.1-1.9-.3-2.3-.5-.6-.2-1-.6-1.4-1.1-.4-.4-.9-1-1.1-1.6-.2-.4-.4-1.1-.5-2.3C2.2 15.6 2.2 15.2 2.2 12s0-3.6.1-4.9c.1-1.2.3-1.9.5-2.3.2-.6.6-1 1.1-1.4.4-.4 1-.9 1.6-1.1.4-.2 1.1-.4 2.3-.5C8.4 2.2 8.8 2.2 12 2.2m0-2.2C8.7 0 8.3 0 7 .1 5.7.2 4.7.4 4 .7c-.9.4-1.7 1-2.4 1.7C.9 3.1.3 3.9 0 4.8c-.3.7-.5 1.7-.6 3C-.7 9 .7 9.3.7 12s0 3 .1 4.2c.1 1.3.3 2.3.6 3 .3.9.9 1.7 1.6 2.4.7.7 1.5 1.3 2.4 1.6.7.3 1.7.5 3 .6 1.2.1 1.6.1 4.9.1s3.6 0 4.9-.1c1.3-.1 2.3-.3 3-.6.9-.3 1.7-.9 2.4-1.6.7-.7 1.3-1.5 1.6-2.4.3-.7.5-1.7.6-3 .1-1.2.1-1.6.1-4.9s0-3.6-.1-4.9c-.1-1.3-.3-2.3-.6-3-.3-.9-.9-1.7-1.6-2.4C21.1 1.6 20.3 1 19.4.7c-.7-.3-1.7-.5-3-.6C15.6 0 15.2 0 12 0z"/> <path d="M12 5.8a6.2 6.2 0 1 0 0 12.4A6.2 6.2 0 0 0 12 5.8zm0 10.2a4 4 0 1 1 0-8.1 4 4 0 0 1 0 8.1zM18.4 4.6a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/> 
         </svg> @giovanni.fg </a> 
         <!-- LinkedIn --> 
         <a href="https://linkedin.com/in/giovanni-fg" target="_blank" class="text-blue-400 hover:text-blue-300 flex items-center gap-1"> 
           <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5"> 
             <path d="M4.98 3.5C4.98 5 3.9 6 2.5 6S0 5 0 3.5 1.12 1 2.5 1s2.48 1 2.48 2.5zM.5 8h4V24h-4V8zM8.5 8h3.8v2.2h.1c.5-.9 1.8-1.9 3.7-1.9 3.9 0 4.6 2.5 4.6 5.7V24h-4v-7.8c0-1.9 0-4.4-2.7-4.4-2.7 0-3.1 2.1-3.1 4.2V24h-4V8z"/> 
           </svg> 
           giovanni-fg 
         </a> 
       </p> 
     </div>

    <div class="w-full max-w-2xl mx-auto p-4">

        <!-- TELA DE SELE√á√ÉO DE IDIOMA -->
        <div id="language-selection">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2">Bem-vindo ao Polyglot AI</h1>
                <p class="text-lg text-gray-400">Qual linguagem voc√™ quer treinar hoje? ü§î</p>
            </div>
            <div id="language-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Bot√µes de idioma ser√£o inseridos aqui pelo JavaScript -->
            </div>
        </div>

        <!-- TELA DE CHAT -->
        <div id="chat-view" class="h-[90vh] w-full flex flex-col bg-gray-800 rounded-2xl shadow-2xl">
            <!-- Cabe√ßalho do Chat -->
            <header class="flex items-center p-4 border-b border-gray-700">
                <button id="back-button" class="mr-4 text-gray-400 hover:text-white transition-colors">&larr; Voltar</button>
                <img id="chat-flag" src="" alt="Bandeira do Idioma" class="w-8 h-8 rounded-full mr-3">
                <h2 id="chat-language-name" class="text-xl font-semibold"></h2>
            </header>

            <!-- Mensagens do Chat -->
            <div id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-6">
                <!-- Mensagens do chat ser√£o inseridas aqui -->
            </div>

            <!-- √Årea de Input (Texto e Microfone) -->
            <footer class="p-4 border-t border-gray-700">
                 <p id="mic-status" class="text-gray-400 text-sm min-h-[1.5rem] mb-2 text-center transition-opacity duration-300">Pronto para come√ßar...</p>
                <div class="flex items-center space-x-2">
                    <input type="text" id="text-input" class="w-full bg-gray-700 border-gray-600 rounded-full py-3 px-5 text-white placeholder-gray-400" placeholder="Digite sua mensagem...">
                    <button id="send-button" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                          <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                        </svg>
                    </button>
                    <button id="mic-button" class="bg-green-600 text-white rounded-full p-3 hover:bg-green-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                          <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                          <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO E ELEMENTOS DO DOM ---
        const languageSelectionView = document.getElementById('language-selection');
        const chatView = document.getElementById('chat-view');
        const languageButtonsContainer = document.getElementById('language-buttons');
        const backButton = document.getElementById('back-button');
        const chatFlag = document.getElementById('chat-flag');
        const chatLanguageName = document.getElementById('chat-language-name');
        const chatMessages = document.getElementById('chat-messages');
        const micButton = document.getElementById('mic-button');
        const micStatus = document.getElementById('mic-status');
        const textInput = document.getElementById('text-input');
        const sendButton = document.getElementById('send-button');

        // --- DADOS DOS IDIOMAS ---
        const languages = [
            { code: 'pt-BR', name: 'Portugu√™s', flag: 'https://flagcdn.com/w320/br.png', voiceName: 'Google portugu√™s do Brasil' },
            { code: 'en-US', name: 'English', flag: 'https://flagcdn.com/w320/us.png', voiceName: 'Google US English' },
            { code: 'es-ES', name: 'Espa√±ol', flag: 'https://flagcdn.com/w320/es.png', voiceName: 'Google espa√±ol' },
            { code: 'fr-FR', name: 'Fran√ßais', flag: 'https://flagcdn.com/w320/fr.png', voiceName: 'Google fran√ßais' },
            { code: 'de-DE', name: 'Deutsch', flag: 'https://flagcdn.com/w320/de.png', voiceName: 'Google Deutsch' },
            { code: 'it-IT', name: 'Italiano', flag: 'https://flagcdn.com/w320/it.png', voiceName: 'Google italiano' },
            { code: 'ja-JP', name: 'Êó•Êú¨Ë™û', flag: 'https://flagcdn.com/w320/jp.png', voiceName: 'Google Êó•Êú¨Ë™û' },
            { code: 'ko-KR', name: 'ÌïúÍµ≠Ïñ¥', flag: 'https://flagcdn.com/w320/kr.png', voiceName: 'Google ÌïúÍµ≠Ïùò' },
        ];

        let selectedLanguage = null;
        let recognition = null;
        let isListening = false;
        let finalTranscript = '';
        
        // --- API DO GEMINI ---
        const apiKey = "AIzaSyA0LecQ2UW0nZvLTlnp-Utp4NHxVeIfvX8"; // Chave de API inserida
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeLanguageButtons();
            setupEventListeners();
            setupSpeechAPI();
        });
        
        function initializeLanguageButtons() {
            languages.forEach(lang => {
                const button = document.createElement('button');
                button.className = 'h-32 bg-cover bg-center rounded-lg shadow-md flex items-center justify-center text-white font-bold text-xl p-4 transition-transform transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
                button.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(${lang.flag})`;
                button.textContent = lang.name;
                button.dataset.langCode = lang.code;
                button.addEventListener('click', () => selectLanguage(lang.code));
                languageButtonsContainer.appendChild(button);
            });
        }
        
        function setupEventListeners() {
            backButton.addEventListener('click', () => {
                chatView.style.display = 'none';
                languageSelectionView.style.display = 'block';
                chatMessages.innerHTML = '';
            });
            micButton.addEventListener('click', toggleListening);
            sendButton.addEventListener('click', sendTextMessage);
            textInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendTextMessage();
                }
            });
            chatMessages.addEventListener('click', handleChatMessageClick);
        }

        function handleChatMessageClick(e) {
            const translateButton = e.target.closest('.translate-msg-btn');
            if (translateButton) {
                handleSingleMessageTranslation(translateButton);
            }
        }

        function sendTextMessage() {
            const text = textInput.value.trim();
            if (text) {
                processUserMessage(text);
                textInput.value = '';
            }
        }

        // --- L√ìGICA DE SELE√á√ÉO DE IDIOMA E NAVEGA√á√ÉO ---
        function selectLanguage(langCode) {
            selectedLanguage = languages.find(l => l.code === langCode);
            languageSelectionView.style.display = 'none';
            chatView.style.display = 'flex';
            chatFlag.src = selectedLanguage.flag;
            chatLanguageName.textContent = selectedLanguage.name;
            recognition.lang = selectedLanguage.code;

            const welcomeMessages = {
                'pt-BR': 'Ol√°! Sou Poly, sua tutora de idiomas. Vamos praticar um pouco de portugu√™s?',
                'en-US': 'Hello! I am Poly, your language tutor. Ready to practice some English?',
                'es-ES': '¬°Hola! Soy Poly, tu tutora de idiomas. ¬øListos para practicar un poco de espa√±ol?',
                'fr-FR': 'Bonjour! Je suis Poly, votre tuteur de langue. Pr√™t √† pratiquer un peu de fran√ßais?',
                'de-DE': 'Hallo! Ich bin Poly, Ihr Sprachlehrer. Bereit, etwas Deutsch zu √ºben?',
                'it-IT': 'Ciao! Sono Poly, il tuo tutor di lingue. Pronto a praticare un po\' di italiano?',
                'ja-JP': '„Åì„Çì„Å´„Å°„ÅØÔºÅÁßÅ„ÅØ„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅÆÂÆ∂Â∫≠ÊïôÂ∏´„ÄÅ„Éù„É™„Åß„Åô„ÄÇÊó•Êú¨Ë™û„ÇíÁ∑¥Áøí„Åô„ÇãÊ∫ñÂÇô„ÅØ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü',
                'ko-KR': 'ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî ÎãπÏã†Ïùò Ïñ∏Ïñ¥ ÍµêÏÇ¨ Ìè¥Î¶¨ÏûÖÎãàÎã§. ÌïúÍµ≠Ïñ¥ Ïó∞ÏäµÌï† Ï§ÄÎπÑ ÎêòÏÖ®ÎÇòÏöî?'
            };
            const welcomeText = welcomeMessages[langCode] || 'Hello! Let\'s start practicing.';
            addAiMessage(null, welcomeText, null);
        }

        // --- L√ìGICA DE VOZ (SPEECH-TO-TEXT & TEXT-TO-SPEECH) ---
        function setupSpeechAPI() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                micStatus.textContent = 'Reconhecimento de voz n√£o suportado.';
                micButton.disabled = true;
                return;
            }
            recognition = new SpeechRecognition();
            recognition.interimResults = true;
            recognition.continuous = true; // Permite √°udio mais longo

            recognition.onstart = () => {
                isListening = true;
                micStatus.textContent = 'Ouvindo... (clique para parar)';
                micButton.classList.add('pulse', 'bg-red-600');
                micButton.classList.remove('bg-green-600');
            };

            recognition.onend = () => {
                isListening = false;
                micStatus.textContent = 'Pronto para come√ßar...';
                micButton.classList.remove('pulse', 'bg-red-600');
                micButton.classList.add('bg-green-600');
                if (finalTranscript.trim()) {
                    processUserMessage(finalTranscript);
                }
                finalTranscript = ''; // Reseta para a pr√≥xima grava√ß√£o
            };
            
            recognition.onerror = (event) => {
                console.error('Erro no reconhecimento de voz:', event.error);
                micStatus.textContent = 'Erro. Tente novamente.';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                micStatus.textContent = finalTranscript + interimTranscript;
            };
        }
        
        function toggleListening() {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }
        
        function speak(text) {
            if (!text || typeof speechSynthesis === 'undefined') return;
            speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            // Tenta encontrar a voz de alta qualidade espec√≠fica do Google primeiro.
            let desiredVoice = voices.find(v => v.name === selectedLanguage.voiceName);
            // Se n√£o encontrar, procura qualquer voz que corresponda ao c√≥digo do idioma.
            if (!desiredVoice) {
                desiredVoice = voices.find(v => v.lang === selectedLanguage.code);
            }
            utterance.voice = desiredVoice;
            utterance.lang = selectedLanguage.code;
            speechSynthesis.speak(utterance);
        }
        
        // Garante que a lista de vozes seja carregada.
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
             speechSynthesis.onvoiceschanged = () => console.log("Vozes de TTS carregadas.");
        }

        // --- L√ìGICA DO CHAT E DA IA ---
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }

        function processUserMessage(text) {
            addUserMessage(text);
            callGeminiAPI(text);
        }

        function addUserMessage(text) {
            const messageHtml = `
                <div class="flex justify-end items-center group space-x-2">
                    <button class="translate-msg-btn text-gray-400 hover:text-white transition-opacity">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-translate pointer-events-none" viewBox="0 0 16 16">
                            <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                            <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.166.45.298.743.382.292.086.62.13.982.13.407 0 .778-.056 1.11-.168.333-.112.603-.27.81-.478.207-.208.355-.465.443-.77.088-.305.133-.636.133-.99V7h-1.12v2.705c0 .31-.03.57-.09.78-.06.21-.15.385-.27.525-.12.14-.27.245-.45.315-.18.07-.38.105-.6.105-.29 0-.55-.04-.78-.12-.23-.08-.43-.2-.6-.36l-.28-.28V7h-1.12v4.032c0 .26.04.5.12.7.08.2.19.37.33.515z"/>
                         </svg>
                    </button>
                    <div class="bg-blue-600 text-white p-4 rounded-l-lg rounded-t-lg max-w-xs sm:max-w-md">
                        <p class="message-text" data-original-text="${escapeHTML(text)}">${text}</p>
                    </div>
                </div>`;
            chatMessages.innerHTML += messageHtml;
            scrollToBottom();
        }

        function addAiMessage(feedback, response, suggestion) {
             const thinkingIndicator = document.getElementById('thinking');
             if (thinkingIndicator) thinkingIndicator.remove();
            
            let feedbackHtml = '';
            if (feedback) {
                feedbackHtml = `
                 <div class="flex justify-start items-center group space-x-2 mt-2">
                     <div class="bg-gray-600 text-gray-300 text-sm p-2 rounded-lg max-w-xs sm:max-w-md">
                        <p class="message-text-feedback" data-original-text="${escapeHTML(feedback)}"><em>${feedback}</em></p>
                    </div>
                     <button class="translate-msg-btn text-gray-400 hover:text-white transition-opacity">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-translate pointer-events-none" viewBox="0 0 16 16">
                            <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                            <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.166.45.298.743.382.292.086.62.13.982.13.407 0 .778-.056 1.11-.168.333-.112.603-.27.81-.478.207-.208.355-.465.443-.77.088-.305.133-.636.133-.99V7h-1.12v2.705c0 .31-.03.57-.09.78-.06.21-.15.385-.27.525-.12.14-.27.245-.45.315-.18.07-.38.105-.6.105-.29 0-.55-.04-.78-.12-.23-.08-.43-.2-.6-.36l-.28-.28V7h-1.12v4.032c0 .26.04.5.12.7.08.2.19.37.33.515z"/>
                         </svg>
                    </button>
                </div>
                `;
            }
            
            let suggestionHtml = '';
            if (suggestion) {
                suggestionHtml = `
                <div class="flex justify-start mt-3">
                    <button class="suggestion-button bg-gray-600 text-gray-200 text-sm py-2 px-4 rounded-full hover:bg-gray-500 transition-colors" data-suggestion="${escapeHTML(suggestion)}">
                        ‚ú® Tente responder: "${escapeHTML(suggestion)}"
                    </button>
                </div>
                `;
            }

            const messageHtml = `
                <div>
                     <div class="flex justify-start items-center group space-x-2">
                        <div class="bg-gray-700 text-white p-4 rounded-r-lg rounded-t-lg max-w-xs sm:max-w-md">
                            <p class="message-text" data-original-text="${escapeHTML(response)}">${response}</p>
                        </div>
                        <button class="translate-msg-btn text-gray-400 hover:text-white transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-translate pointer-events-none" viewBox="0 0 16 16">
                               <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                               <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.166.45.298.743.382.292.086.62.13.982.13.407 0 .778-.056 1.11-.168.333-.112.603-.27.81-.478.207-.208.355-.465.443-.77.088-.305.133-.636.133-.99V7h-1.12v2.705c0 .31-.03.57-.09.78-.06.21-.15.385-.27.525-.12.14-.27.245-.45.315-.18.07-.38.105-.6.105-.29 0-.55-.04-.78-.12-.23-.08-.43-.2-.6-.36l-.28-.28V7h-1.12v4.032c0 .26.04.5.12.7.08.2.19.37.33.515z"/>
                            </svg>
                        </button>
                    </div>
                    ${feedbackHtml}
                    ${suggestionHtml}
                </div>`;
            chatMessages.innerHTML += messageHtml;
            
            document.querySelectorAll('.suggestion-button:not(.listener-added)').forEach(button => {
                button.classList.add('listener-added');
                button.addEventListener('click', (e) => {
                    textInput.value = e.currentTarget.dataset.suggestion;
                    textInput.focus();
                });
            });

            speak(response);
            scrollToBottom();
        }
        
        function showThinkingIndicator() {
            const thinkingHtml = `
            <div id="thinking" class="flex justify-start">
                <div class="bg-gray-700 p-4 rounded-r-lg rounded-t-lg flex items-center space-x-2">
                    <div class="thinking-dot w-2.5 h-2.5 bg-gray-400 rounded-full"></div>
                    <div class="thinking-dot w-2.5 h-2.5 bg-gray-400 rounded-full"></div>
                    <div class="thinking-dot w-2.5 h-2.5 bg-gray-400 rounded-full"></div>
                </div>
            </div>`;
            chatMessages.innerHTML += thinkingHtml;
            scrollToBottom();
        }
        
        async function callGeminiAPI(text) {
            showThinkingIndicator();

            if (!apiKey) {
                const thinkingIndicator = document.getElementById('thinking');
                if (thinkingIndicator) thinkingIndicator.remove();
                const keyErrorMessage = selectedLanguage.code === 'pt-BR' 
                    ? "Por favor, adicione sua chave de API do Google AI Studio na vari√°vel 'apiKey' no c√≥digo para come√ßar." 
                    : "Please add your Google AI Studio API key to the 'apiKey' variable in the code to get started.";
                addAiMessage(null, keyErrorMessage, null);
                return;
            }

            const systemPrompt = `Voc√™ √© Poly, um parceiro de conversa√ß√£o de idiomas para falantes de ${selectedLanguage.name}. Aja como uma pessoa real, n√£o um rob√¥. Seu objetivo √© ter uma conversa natural, interessante e humana.
1.  **Analisar:** Avalie a frase "${text}". Forne√ßa um feedback curto e positivo. Se houver um erro, corrija-o de forma amig√°vel, como um amigo faria.
2.  **Puxar Papo:** Responda ao usu√°rio de forma que a conversa flua. Fa√ßa perguntas, compartilhe "opini√µes" e puxe novos assuntos. Sua resposta deve ser cativante e humana, como se fosse um amigo batendo papo. Use emojis.
3.  **Sugerir Pr√≥ximo Passo:** D√™ uma sugest√£o de pergunta para o usu√°rio, para que ele nunca fique sem saber o que dizer.
Responda SEMPRE em um objeto JSON v√°lido com tr√™s chaves: "pronunciationFeedback", "chatResponse", e "suggestedQuestion". O texto para TODAS as chaves deve ser estritamente no idioma ${selectedLanguage.name}.`;
            
            const payload = {
                contents: [{ parts: [{ text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const aiData = JSON.parse(jsonText);
                addAiMessage(aiData.pronunciationFeedback, aiData.chatResponse, aiData.suggestedQuestion);
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                const errorMessage = selectedLanguage.code === 'pt-BR' ? "Desculpe, tive um problema para me conectar. Vamos tentar de novo?" : "Sorry, I had trouble connecting. Shall we try again?";
                addAiMessage(null, errorMessage, null);
            }
        }
        
        // --- L√ìGICA DE TRADU√á√ÉO POR MENSAGEM ---
        async function translateText(text, targetLang = 'pt-BR') {
            const translatePrompt = `Translate the following text to ${targetLang}. Respond with ONLY the translated text, without any additional explanation or formatting. Text to translate: "${text}"`;
            const payload = { contents: [{ parts: [{ text: translatePrompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Network response was not ok.');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("Translation API error:", error);
                return `[Erro na tradu√ß√£o]`;
            }
        }

        async function handleSingleMessageTranslation(button) {
            const messageContainer = button.parentElement;
            const textElement = messageContainer.querySelector('[data-original-text]');
            if (!textElement) return;

            button.disabled = true;
            const originalText = textElement.dataset.originalText;
            const isCurrentlyTranslated = textElement.dataset.isTranslated === 'true';

            if (isCurrentlyTranslated) {
                textElement.innerHTML = originalText;
                textElement.dataset.isTranslated = 'false';
            } else {
                let translatedText = textElement.dataset.translatedText;
                if (!translatedText) {
                    translatedText = await translateText(originalText);
                    textElement.dataset.translatedText = translatedText;
                }
                textElement.innerHTML = translatedText;
                textElement.dataset.isTranslated = 'true';
            }
            // Re-apply emphasis for feedback messages if needed
            if (textElement.classList.contains('message-text-feedback')) {
                textElement.innerHTML = `<em>${textElement.innerHTML}</em>`;
            }

            button.disabled = false;
        }


        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

    </script>
</body>
</html>

